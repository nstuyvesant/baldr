<!doctype html>
<html lang="en-US">

<head>
    <title>Perfecto Automation Assessment</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="x-ua-compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Perfecto Automation Assessment - The path to high levels of automation success" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha256-NJWeQ+bs82iAeoT5Ktmqbi3NXwxcHlfaVejzJI2dklU=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous" />
    <style>
        h1, h2, .green {
            color: #82bc41;
        }
        h2 {
            margin-top: 30px;
            margin-bottom: 10px;
        }
        .red {
            color: red;
        }
        .orange {
            color: orange;
        }
        h1 {
            filter: none;
            margin-bottom: 0px;
            margin-top: 30px;
        }
        .metric {
            font-size: 2rem;
        }
        .logo {
            height:70px;
            width: 220px;
            margin-top: 20px;
        }
        /* Chart.js */
        @-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}   
    </style>
</head>

<body>
    <!--[if lt IE 10]>
      <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <div id="noData" class="alert alert-danger collapse" role="alert">
        No snapshot found for cloud = <span id="alertCloud"></span>, date = <span id="alertSnapshotDate"></span>
    </div>
    <div id="main" class="container collapse">
        <img src="perfecto-logo.svg" class="logo" />
        <div class="row">
            <div class="col-md-6">
                <h1>Automation Analysis</h1>
                <p class="lead"><span id="fqdn"></span> | <span id="snapshotDate"></span></p>
            </div>
            <div class="col-md-2 text-center">
                <div class="card">
                    <div class="card-body">
                        <span class="metric font-weight-bold"><span id="last24h"></span>%</span><br/>Last 24h
                    </div>
                </div>
            </div>
            <div class="col-md-2 text-center">
                <div class="card">
                    <div class="card-body">
                        <span class="metric font-weight-bold"><span id="last7d"></span>%</span><br/>Last 7d
                    </div>
                </div>
            </div>
            <div class="col-md-2 text-center">
                <div class="card">
                    <div class="card-body">
                        <span class="metric font-weight-bold"><span id="last14d"></span>%</span><br/>Last 14d
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h2>What is impacting my automation success rate? </h2>
                <canvas id="myChart"></canvas>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h2>How to increase success rate by <span id="totalImpact"></span>%</h2>
                <table id="recommendationsTable" class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Recommendation</th>
                            <th scope="col">Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h2>Top 5 problematic devices</h2>
                <table id="devicesTable" class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Model</th>
                            <th scope="col">OS</th>
                            <th scope="col">ID</th>
                            <th scope="col">Errors</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h2>Top 5 failing tests (maturity > 3 days)</h2>
                <table id="testsTable" class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Test</th>
                            <th scope="col">Age</th>
                            <th scope="col">Failures</th>
                            <th scope="col">Passes</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
    <footer class="copyright">
        <div class="container">
            <div class="row">
                <nav class="nav">
                    <a class="nav-link"><small>&copy; 2018 Perfecto Mobile, Inc. All Rights Reserved.</small></a>
                </nav>
            </div>
        </div>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha256-98vAGjEDGN79TjHkYWVD4s87rvWkdWLHPs5MC3FvFX4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha256-C8oQVJ33cKtnkARnmeWp6SDChkU+u7KvsNMFUzkkUzk=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js" integrity="sha256-XF29CBwU1MWLaGEnsELogU6Y6rcc5nCkhhx89nFMIDQ=" crossorigin="anonymous"></script>
    <script>
        // Extract querystring values
        function qs (key) {
            key = key.replace(/[*+?^$.[\]{}()|\\/]/g, '\\$&') // escape RegEx meta chars
            let match = location.search.match(new RegExp('[?&]' + key + '=([^&]+)(&|$)'))
            return match && decodeURIComponent(match[1].replace(/\+/g, ' '))
        }

        // Extend jQuery to color code success rate values
        jQuery.fn.extend({
            colorCode: function () {
                return this.each(function() {
                    let element = $('#' + this.id)
                    let value = parseInt(element.text(), 10)
                    let color
                    if (value > 70) {
                        color = 'green'
                    } else if (value > 50) {
                        color = 'orange'
                    } else {
                        color = 'red'
                    }
                    element.parent().addClass(color)
                })
            }
        })

        // DOM ready
        $(document).ready(function () {
            // Get cloud and date values from querystring
            let cloud = qs('cloud')
            let snapshotDate = qs('date')

            // Load content from our API
            $.getJSON('/api/?cloud=' + cloud + '&date=' + snapshotDate, function (reportData) {
                // Show main report (hidden in case we need to show alert due to no data)
                $('#main').collapse('show')

                // Setup chart reference
                const ctx = $('#myChart')

                // Setup chart structure
                const chartData = {
                    labels: [
                            'Lab',
                            'Orchestration',
                            'Scripting'
                    ],
                    datasets: [
                        {
                            data: [reportData.lab, reportData.orchestration, reportData.scripting],
                            backgroundColor: [
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)'
                            ],
                            borderColor: [
                                'rgba(153, 102, 255, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)'
                            ],
                            borderWidth: 1
                        }
                    ]
                }

                // Setup chart look and feel
                const chartOptions = {
                    devicePixelRatio: 2,
                    events: false,
                    animation: {
                        duration: 500,
                        easing: 'easeOutQuart',
                        onComplete: function () {
                            var ctx = this.chart.ctx
                            ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontFamily, 'normal', Chart.defaults.global.defaultFontFamily)
                            ctx.textAlign = 'center'
                            ctx.textBaseline = 'bottom'

                            this.data.datasets.forEach(function (dataset) {
                                for (let i = 0; i < dataset.data.length; i++) {
                                    let model = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._model,
                                        total = dataset._meta[Object.keys(dataset._meta)[0]].total,
                                        mid_radius = model.innerRadius + (model.outerRadius - model.innerRadius)/2,
                                        start_angle = model.startAngle,
                                        end_angle = model.endAngle,
                                        mid_angle = start_angle + (end_angle - start_angle)/2

                                    let x = mid_radius * Math.cos(mid_angle)
                                    let y = mid_radius * Math.sin(mid_angle)

                                    ctx.fillStyle = '#000'

                                    let percent = String(Math.round(dataset.data[i]/total*100)) + '%'
                                    ctx.fillText(dataset.data[i], model.x + x, model.y + y)
                                    // Display percent in another line, line break doesn't work for fillText
                                    ctx.fillText(percent, model.x + x, model.y + y + 15)
                                }
                            })
                        }
                    }
                }

                // Create doughnut with our data and options
                const myDoughnutChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: chartOptions
                })

                // Fill in UI
                $('#fqdn').text(reportData.fqdn)
                $('#snapshotDate').text(reportData.snapshotDate)
                $('#last24h').text(reportData.last24h)
                $('#last24h').colorCode()
                $('#last7d').text(reportData.last7d).colorCode()
                $('#last14d').text(reportData.last14d).colorCode()
                let totalImpact = 0
                let tableRow = ''
                let impactText = ''

                // Create table of recommendations
                for (let index in reportData.recommendations) {
                    let recommendation = reportData.recommendations[index]
                    if (recommendation.impact) {
                        totalImpact += parseInt(recommendation.impact, 10)
                        impactText = '+' + recommendation.impact + '%'
                    } else {
                        impactText = recommendation.impactMessage
                    }
                    tableRow = '<tr><th scope="row">' + recommendation.rank + '</th><td>' + recommendation.recommendation + '</td><td class="green">' + impactText + '</td></tr>'
                    $('#recommendationsTable > tbody:last-child').append(tableRow)
                }

                // Create table of problematic devices
                $('#totalImpact').text(totalImpact)
                for (let index in reportData.topProblematicDevices) {
                    let problematicDevice = reportData.topProblematicDevices[index]
                    tableRow = '<tr><th scope="row">' + problematicDevice.rank + '</th><td>' + problematicDevice.model + '</td><td>' + problematicDevice.os + '</td><td>' + problematicDevice.id + '</td><td>' + problematicDevice.errors + '</td></tr>'
                    $('#devicesTable > tbody:last-child').append(tableRow)
                }

                // Create table of problematic tests
                for (let index in reportData.topFailingTests) {
                    let test = reportData.topFailingTests[index]
                    tableRow = '<tr><th scope="row">' + test.rank + '</th><td>' + test.test + '</td><td>' + test.age + 'd</td><td>' + test.failures + '</td><td>' + test.passes + '</td></tr>'
                    $('#testsTable > tbody:last-child').append(tableRow)
                }
            }) // Get JSON
            .fail(function() { // Handle no data for cloud/date combination
                // Set alert message
                $('#alertCloud').text(cloud)
                $('#alertSnapshotDate').text(snapshotDate)
                $('#noData').collapse('show') // show alert
            })
        }) // DOM read
    </script>
</body>

</html>