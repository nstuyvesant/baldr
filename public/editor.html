<!doctype html>
<html lang="en-US">

<head>
    <title>Baldr JSON Snapshot Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha256-NJWeQ+bs82iAeoT5Ktmqbi3NXwxcHlfaVejzJI2dklU=" crossorigin="anonymous" />
</head>

<body>
  <div class="container" style="margin-top:30px">
    <form id="theForm" action="/api" method="POST">
      <div class="row">
        <div class="col-md-12">
          <div class="form-group">
            <label for="snapshot">JSON Snapshot to Upsert</label>
            <textarea class="form-control" id="snapshot" name="snapshot" rows="25"></textarea>
          </div>
          <button class="btn btn-success" type="submit">Submit</button>
        </div>
      </div>
    </form>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha256-C8oQVJ33cKtnkARnmeWp6SDChkU+u7KvsNMFUzkkUzk=" crossorigin="anonymous"></script>
  <script>
    // Extract querystring values
    function qs (key) {
      key = key.replace(/[*+?^$.[\]{}()|\\/]/g, '\\$&') // escape RegEx meta chars
      let match = location.search.match(new RegExp('[?&]' + key + '=([^&]+)(&|$)'))
      return match && decodeURIComponent(match[1].replace(/\+/g, ' '))
    }

    const cloud = qs('cloud')
    const securityToken = qs('securityToken')
    const user = qs('user')
    const password = qs('password')
    
    // Favor securityToken over user/password combination
    const securityParams = securityToken ? '&securityToken=' + securityToken : '&user=' + user + '&password=' + password

    // Handle submit on request form
    $('#theForm').on('submit', function (e) {
      e.preventDefault()
      const data = $(this).serialize()
      const url = '/api/?cloud=' + cloud + securityParams
      $.post(url, data, function (response) {
        alert(response.message)
      })
      .fail(function(e) {
        alert(e.responseJSON.message)
      })
    })

    // DOM ready
    $(document).ready(function() {
      // check if baldr has json values if date is mentioned in the queryString
      const date = qs('date')
      if (!jQuery.isEmptyObject(date)) {
         // query baldr for a specific date in query String
         const url = window.location.origin + '/api/?cloud=' + cloud + '&date=' + date + securityParams
         var msg = $.ajax({
                           type: "GET",
                           url: url,
                           contentType: 'application/json; charset=utf-8',
                           async: false
                           }).responseText;
          //Update the existing json in the editor if it exists for the specified date else show the sample-input
          if (msg.indexOf('fqdn') != -1) {
                  $('#snapshot').val(msg)
              } else {
                      $.getJSON('sample-input.json', function(jsonValue) {
                        $('#snapshot').val(JSON.stringify(jsonValue))
                        })
              }
      } else {
      //show the sample input if date is not passed in the queryString
      $.getJSON('sample-input.json', function(jsonValue) {
                $('#snapshot').val(JSON.stringify(jsonValue))
                })
      }
    })
  </script>
</body>
</html>
